---
description: 记录代码修改详情，生成结构化的变更文档（配合 /commit 使用）
model: opus
---

# 代码修改记录技能

记录基于 Git 未提交变更的详细代码修改，生成结构化文档用于项目管理和知识积累。

## 执行流程

### 1. 检测 Git 变更

使用 Bash 工具执行以下命令获取变更信息：

```bash
# 获取变更文件列表
git status --porcelain

# 获取详细变更内容（包含行号）
git diff HEAD

# 获取新增文件内容
git diff --cached
```

分析变更文件，根据当前项目结构分类为：

- 前端变更：`*-admin/`、`*-miniapp/` 下的文件
- 后端变更：`*-api/` 下的文件（Gemini.Api / Gemini.Service / Gemini.Model）
- 配置变更：`*.json`, `*.yml`, `*.csproj`, `package.json`, `tsconfig.json` 等
- 数据库变更：Model 类变更（MongoDB 集合结构）、迁移脚本

### 2. 检查今日记录文件

检查项目根目录下是否已存在今日的修改记录文件：

```bash
# 获取当前日期（格式：YYYYMMDD）
date +%Y%m%d

# 检查文件是否存在（优先项目管理目录，其次根目录）
ls docs/项目管理/$(date +%Y%m%d)_修改记录.md 2>/dev/null || ls $(date +%Y%m%d)_修改记录.md 2>/dev/null
```

- 如果文件存在 → 读取文件，准备增量追加
- 如果文件不存在 → 创建新文件，使用完整模板
- 记录目录优先级：`{项目}/docs/项目管理/` > 项目根目录

### 3. 分析变更内容

#### 前端变更分析

- 提取变更文件路径
- 识别变更类型（新增组件/修改功能/样式调整）
- 简要描述功能变化（不需要详细代码）

#### 后端变更分析（详细）

**API 端点层**（Gemini.Api）：

- 提取 `MapXxxEndpoints` 扩展方法变更
- 识别 API 路由变化（auth/admin/public 分组）
- 记录请求/响应参数变化

**Service 层**（Gemini.Service）：

- 提取业务逻辑变更
- 记录方法签名变化
- 标注关键业务规则变更

**Model 层**（Gemini.Model）：

- 提取字段变更（新增/修改/删除）
- 生成字段对比表
- 关联 MongoDB 集合名（`CollName`）

**配置文件**：

- 提取 `appsettings.json` 配置项变更（⚠️ 注意脱敏）
- 对比变更前后的值
- 说明配置变更的影响范围

**依赖变更**：

- 解析 `*.csproj` 的 `<PackageReference>` 变更
- 解析 `package.json` 的依赖变更
- 记录新增/删除/版本升级的依赖

#### 数据库变更分析（重点标记 ⚠️）

**MongoDB 集合结构变更**：

- 搜索 Model 类的字段变更
- 提取新增/修改/删除的属性
- 生成字段变更对比表：

| 字段名 | 变更前类型 | 变更后类型 | 说明 |
|--------|-----------|-----------|------|
| xxx | string | int | 类型变更 |
| newField | - | string | 新增字段 |

**数据迁移**：

- 提取初始化脚本或迁移代码
- 说明数据迁移的目的和影响

#### 脚本变更分析（重点标记 ⚠️）

- 识别部署脚本变更（`Dockerfile`, `*.ps1`, `*.sh`, `docker-compose.yml`）
- 记录脚本变更内容
- 说明对部署流程的影响

### 4. 生成结构化记录

使用以下模板生成记录文档：

```markdown
# 修改记录 - YYYY年MM月DD日

## 本次变更概述
- **变更类型**：[feat/fix/refactor/perf/docs/chore]
- **影响范围**：[前端/后端/数据库/配置]
- **关联需求/Bug**：[描述或编号]
- **变更时间**：HH:MM

---

## 前端变更

### 新增功能
- **文件**：[路径/文件名.tsx:行号](路径/文件名.tsx#L行号)
- **变更内容**：[简要描述]

### 修改功能
- **文件**：[路径/文件名.tsx:行号-行号](路径/文件名.tsx#L行号-L行号)
- **修改说明**：[描述功能变化]

---

## 后端变更

### 1. 代码变更

#### API 端点层（Gemini.Api）
- **文件**：[Gemini.Api/Xxx/XxxApi.cs:行号](路径#L行号)
- **变更类型**：[新增/修改/删除]
- **API 端点**：`POST /api/v1/xxx/auth/method`
- **说明**：[详细说明变更原因和影响]

#### Service 层（Gemini.Service）
- **文件**：[Gemini.Service/XxxApiService.cs:行号](路径#L行号)
- **变更类型**：[新增/修改/删除]
- **方法签名**：`Task<BaseResult> MethodName(RequestType request)`
- **代码片段**：（关键逻辑）
- **说明**：[业务逻辑变更说明]

#### Model 层（Gemini.Model）
- **文件**：[Gemini.Model/XxxModel.cs:行号](路径#L行号)
- **集合名**：`CollName = "xxx"`
- **字段变更**：[新增字段/修改字段/删除字段]
- **说明**：[字段用途和业务含义]

### 2. 配置变更 ⚠️

#### appsettings.json（脱敏）
- **变更内容**：[描述配置项变更，隐藏敏感值]
- **影响**：[说明配置变更的影响范围]

### 3. 依赖变更

#### *.csproj / package.json
- **新增**：[包名@版本] — [原因]
- **删除**：[包名] — [原因]
- **升级**：[包名] 从 v1 → v2 — [原因]

### 4. 数据库变更 ⚠️

#### MongoDB 集合结构变更
- **集合名**：`xxx`
- **字段变更对比**：（表格）
- **说明**：[变更原因]

### 5. 脚本变更 ⚠️
- **脚本路径**：[路径]
- **变更内容**：[描述]
- **影响**：[对部署流程的影响]

---

## 测试验证
- [ ] 本地测试通过
- [ ] 接口测试通过（Swagger）
- [ ] 数据库变更验证
- [ ] 前端功能验证
- [ ] 集成测试通过

---

## 注意事项
- [部署时需要注意的事项]
- [可能的风险点]
- [回滚方案]

---

## 相关文件清单
- 前端文件：[列出所有变更的前端文件]
- 后端文件：[列出所有变更的后端文件]
- 配置文件：[列出所有变更的配置文件]
```

### 5. 写入文件

#### 新建文件
如果是当天第一次记录，创建新文件：
- 目录优先级：`{项目}/docs/项目管理/` > 项目根目录
- 文件名格式：`YYYYMMDD_修改记录.md`

#### 增量追加
如果当天已有记录，在文件末尾追加新记录：

```markdown
---

## 变更记录 #{序号} - HH:MM

[使用相同的模板结构，但省略文件头部]
```

### 6. 代码片段处理规则

**长代码处理**：
- 如果代码超过 20 行，保留头部（前 5 行）和尾部（后 5 行）
- 中间部分用 `// ... 省略 N 行 ...` 标注
- 确保保留的部分包含关键逻辑（方法签名、核心业务逻辑、返回语句）

**行号标注**：
- 使用 `git diff` 的输出提取准确的行号
- 在 Markdown 中使用链接格式：`[文件路径:行号](文件路径#L行号)`

## 变更类型判断规则

根据 Conventional Commits 规范自动判断：

- **feat**：新增功能、新增 API、新增页面
- **fix**：Bug 修复、错误处理改进
- **refactor**：代码重构、优化逻辑（不改变功能）
- **perf**：性能优化、查询优化、缓存改进
- **style**：代码格式、注释调整（不影响功能）
- **docs**：文档更新、注释完善
- **chore**：构建配置、依赖更新、工具脚本

判断依据：
1. 检查 commit message（如果用户提供）
2. 分析代码变更内容（新增方法 → feat，修改逻辑 → fix/refactor）
3. 如果无法判断，询问用户

## 重点标记规则

使用 ⚠️ 标记以下内容：
- 数据库变更（集合结构、数据迁移）
- 脚本变更（部署脚本、Dockerfile）
- 配置变更（可能影响生产环境）
- 依赖变更（可能引入兼容性问题）

## 安全规则

- **禁止**记录 `appsettings.json` 中的敏感值（连接字符串、密钥、密码）
- 配置变更只记录 key 和变更说明，不记录具体 value
- 不记录 `.env` 文件内容

## 执行步骤总结

1. 使用 Bash 执行 `git status --porcelain` 和 `git diff HEAD`
2. 分析变更文件，按前端/后端/数据库/配置分类
3. 检查今日记录文件是否存在
4. 如果存在，读取文件内容准备追加
5. 根据变更内容填充模板
6. 对于后端代码，提取详细的代码片段和行号
7. 对于数据库变更，生成字段对比表
8. 写入文件（新建或追加）
9. 输出文件路径和变更统计

## 输出示例

```
✅ 修改记录已生成

📄 文件路径：docs/项目管理/20260219_修改记录.md

📊 变更统计：
- 前端文件：3 个
- 后端文件：5 个
- 配置文件：1 个
- 数据库变更：1 个集合 ⚠️

💡 提示：配合 /commit 使用，提交前记录变更
```
